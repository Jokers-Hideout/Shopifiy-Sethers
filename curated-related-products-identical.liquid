{% comment %}
  Curated Related Products â€” IDENTICAL to "Recently viewed"
  Data: product.metafields.custom.related_products_curated (List of products)
{% endcomment %}

{% liquid
  assign related_list = product.metafields.custom.related_products_curated.value
%}

{% if related_list != blank %}
<section class="collection-products">
  <div class="container js-recently-viewed">
    <h2 class="section_title">
      {{ section.settings.heading }}
    </h2>

    <div class="collection-products__slider-wrapper">
      <div
        class="collection-products__slider collection-products__slider--recently-viewed js-recently-viewed-products-slider js-recently-viewed-products-home js-curated-related-products-slider"
        data-products-limit="{{ section.settings.max_items }}"
      >
        {%- assign shown = 0 -%}
        {%- for related in related_list -%}
          {%- if related and related.id != product.id -%}
            {%- assign _original = product -%}
            {%- assign product = related -%}

            <div class="collection-products__item">
              {%- if section.settings.card_snippet == 'grid_navigation' -%}
                {%- render 'product-grid-navigation', product: product -%}
              {%- else -%}
                {%- render 'product-grid-item',
                  product: product,
                  product_list_class: "",
                  mobile_product_list_class: "grid_less_padding"
                -%}
              {%- endif -%}
            </div>

            {%- assign product = _original -%}
            {%- assign shown = shown | plus: 1 -%}
            {%- if shown >= section.settings.max_items -%}{% break %}{% endif -%}
          {%- endif -%}
        {%- endfor -%}
      </div>

      <div class="collection-products__slider-arrow collection-products__slider-arrow--prev js-recently-viewed-products-prev">
        <i class='shoptimized-064'></i>
      </div>

      <div class="collection-products__slider-arrow collection-products__slider-arrow--next js-recently-viewed-products-next">
        <i class='shoptimized-074'></i>
      </div>
    </div>
  </div>

  <style>
    /* Let Slick handle widths; kill grid floats in slides */
    .js-curated-related-products-slider .grid__item{ float:none !important; width:auto !important; margin:0 !important; display:block !important; }
    .js-curated-related-products-slider .collection-products__item{ padding:0 10px; box-sizing:border-box; }
  </style>

  <script>
    (function(){
      function initCuratedSlider(){
        var $ = window.jQuery || window.$;
        if (!$) return;

        var $wrap = $('.js-recently-viewed').last();
        var $slider = $wrap.find('.js-curated-related-products-slider');

        if (!$slider.length || !$slider.slick || $slider.hasClass('slick-initialized')) return;

        $slider.slick({
          slidesToShow: 5,
          slidesToScroll: 5,
          infinite: false,
          speed: 300,
          arrows: true,
          prevArrow: $wrap.find('.js-recently-viewed-products-prev'),
          nextArrow: $wrap.find('.js-recently-viewed-products-next'),
          responsive: [
            { breakpoint: 990, settings: { slidesToShow: 3, slidesToScroll: 3 } },
            { breakpoint: 750, settings: { slidesToShow: 2, slidesToScroll: 2 } }
          ]
        });
      }

      if (document.readyState === 'complete' || document.readyState === 'interactive') {
        initCuratedSlider();
      } else {
        document.addEventListener('DOMContentLoaded', initCuratedSlider);
      }
      document.addEventListener('shopify:section:load', initCuratedSlider);
    })();
  </script>
</section>
{% endif %}

{% schema %}
{
  "name": "CRP Identical",
  "tag": "section",
  "class": "curated-related-products--identical",
  "settings": [
    { "type": "text", "id": "heading", "label": "Heading", "default": "Related Products" },
    { "type": "select", "id": "card_snippet", "label": "Product card to use", "options": [
      { "value": "grid_item", "label": "Theme card: product-grid-item" },
      { "value": "grid_navigation", "label": "Theme card: product-grid-navigation" }
    ], "default": "grid_item" },
    { "type": "range", "id": "max_items", "label": "Maximum products to render", "min": 5, "max": 30, "step": 5, "default": 15 }
  ],
  "presets": [
    { "name": "CRP Identical" }
  ]
}
{% endschema %}